<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pensiones — Pirámide poblacional</title>

  <style>
    :root{
      --bg:#252525;
      --primary:#FEF702;
      --text:#B0B0B0;
      --grid:#4A4A4A;
      --stroke:#3a3a3a;

      --workers:#36C3FF;
      --retired:#FF6A00;

      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);

      --fontTitle: "Futura","Trebuchet MS",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --fontText:  Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;

      --fontScale: 1.0;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--fontText); }

    header{
      padding:16px 18px 10px 18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .h-title h1{
      margin:0;
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 26px;
      letter-spacing:.3px;
      line-height:1.05;
    }
    .h-title p{
      margin:6px 0 0 0;
      opacity:.9;
      font-size:13px;
      max-width:90ch;
      line-height:1.35;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:12px;
      opacity:.9;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--primary);
      box-shadow:0 0 0 3px rgba(254,247,2,.15);
    }
    a.back{
      color:var(--text);
      text-decoration:none;
      border-bottom:1px solid rgba(255,255,255,.18);
      padding-bottom:1px;
    }
    a.back:hover{ border-bottom-color: rgba(254,247,2,.35); color:#fff; }

    main{ padding:10px 18px 22px 18px; }

    .panel{
      max-width: 1120px;
      margin: 0 auto;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .ph{
      padding:14px 16px 12px 16px;
      border-bottom:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px;
    }
    .ttl{
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 13px;
      letter-spacing:.35px;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .content{
      padding:14px 16px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:14px;
      align-items:start;
    }

    .card{
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      background:rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card .ch{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .cttl{
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .card .cb{ padding:12px; display:grid; gap:12px; }

    .pyr-frame{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap:12px;
      align-items:stretch;
    }

    .pyr-svg{
      width:100%;
      height:auto;
      aspect-ratio: 520 / 650;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.05);
      background:rgba(0,0,0,.08);
      display:block;
    }

    .vslider-shell{
      background:rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      height:100%;
      position:relative;
    }

    .vslider-shell input[type="range"]{
      -webkit-appearance: none;
      appearance: none;
      width: 260px;
      height: 4px;
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%) rotate(-90deg);
      transform-origin: center;
      cursor: pointer;
      display:block;
      background: rgba(255,255,255,.12);
      border-radius:999px;
    }

    .ctl{ display:grid; gap:6px; }
    .ctl label{
      font-size:13px;
      opacity:.92;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .val{ font-variant-numeric: tabular-nums; opacity:.95; }

    input[type="range"]{
      width:100%;
      display:block;
      margin:0;
      accent-color: var(--primary);
      background: rgba(255,255,255,.12);
      border-radius:999px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 4px;
      background: transparent;
      border-radius:999px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      border: 1px solid rgba(0,0,0,.35);
      margin-top: -5px;
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    input[type="range"]::-moz-range-track{
      height:4px;
      background: transparent;
      border-radius:999px;
    }
    input[type="range"]::-moz-range-thumb{
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      border: 1px solid rgba(0,0,0,.35);
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,.06);
    }

    /* Botonera en columna y a ancho completo */
    .btns{
      display:flex;
      flex-direction:column;
      gap:10px;
      width:100%;
    }

    .btn{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      text-align:center;
      font-size:13px;
      width:100%;
      min-width:0;
      display:block;
    }
    .btn:hover{
      border-color: rgba(254,247,2,.35);
      color:#fff;
      background: rgba(254,247,2,.06);
    }
    .btn.primary{
      border-color: rgba(254,247,2,.35);
      color:#111;
      background: rgba(254,247,2,.90);
    }
    .btn.primary:hover{
      background: rgba(254,247,2,1);
    }

    /* Pills (Menores / Laboral / Mayores) */
    .mini{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      font-size:12px;
      opacity:.92;
    }
    .mini-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-variant-numeric: tabular-nums;
    }
    .mini-dot{
      width:9px; height:9px;
      border-radius:50%;
      background: var(--workers);
      box-shadow:0 0 0 3px rgba(54,195,255,.12);
    }
    .mini-dot.ret{ background: var(--retired); box-shadow:0 0 0 3px rgba(255,106,0,.12); }
    .mini-dot.ylw{ background: var(--primary); box-shadow:0 0 0 3px rgba(254,247,2,.12); }

    @media (max-width: 980px){
      .content{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <div class="h-title">
    <h1>Pirámide poblacional</h1>
    <p>
      Configura la estructura por edad que se usará como estado inicial en el simulador.
    </p>
  </div>
  <div class="pill">
    <span class="dot"></span>
    <span><a class="back" href="index.html">Volver</a></span>
  </div>
</header>

<main>
  <section class="panel" aria-label="Configuración de pirámide">
    <div class="ph">
      <div class="ttl">Paso 1 — Pirámide</div>

      <div class="mini" aria-label="Shares por grupo de edad">
        <span class="mini-pill" title="Menores (&lt;18)">
          <span class="mini-dot ylw"></span><span id="shareMin">—</span>
        </span>
        <span class="mini-pill" title="Edad laboral (18–64)">
          <span class="mini-dot"></span><span id="shareWork">—</span>
        </span>
        <span class="mini-pill" title="Mayores (65+)">
          <span class="mini-dot ret"></span><span id="shareRet">—</span>
        </span>
      </div>
    </div>

    <div class="content">
      <div class="card" aria-label="Pirámide por quinquenios">
        <div class="ch">
          <div class="cttl">Pirámide</div>
        </div>

        <div class="cb">
          <div class="pyr-frame">
            <div class="vslider-shell" id="peakShell" title="Pico (quinquenio)">
              <input id="peakSlider" type="range" min="0" max="20" step="1" value="9" />
            </div>

            <svg id="pyrSvg" class="pyr-svg" viewBox="0 0 520 650" preserveAspectRatio="xMidYMid meet" aria-label="Pirámide por quinquenios"></svg>
          </div>
        </div>
      </div>

      <div class="card" aria-label="Parámetros de pirámide">
        <div class="ch">
          <div class="cttl">Parámetros</div>
        </div>

        <div class="cb">
          <div class="ctl">
            <label>
              <span>Dispersión del perfil etario (σ)</span>
              <span class="val mono" id="sigmaVal">18</span>
            </label>
            <input id="sigmaSlider" type="range" min="6" max="40" step="1" value="18" />
          </div>

          <div class="ctl">
            <label>
              <span>Densidad jóvenes (parte inferior)</span>
              <span class="val mono" id="densityYoungVal">0.75</span>
            </label>
            <input id="densityYoungSlider" type="range" min="0.35" max="1.25" step="0.01" value="0.75" />
          </div>

          <div class="ctl">
            <label>
              <span>Densidad mayores (parte superior)</span>
              <span class="val mono" id="densityOldVal">0.75</span>
            </label>
            <input id="densityOldSlider" type="range" min="0.35" max="1.25" step="0.01" value="0.75" />
          </div>

          <div class="btn-row">
            <div class="btns">
              <button id="nextBtn" class="btn primary" type="button">Aceptar</button>
              <button id="oecdBtn" class="btn" type="button">Cargar paises OCDE</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<script>
(() => {
  const CSS = (v) => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

  const COLORS = {
    text: CSS('--text'),
    grid: CSS('--grid'),
    workers: CSS('--workers'),
    retired: CSS('--retired'),
    primary: CSS('--primary'),
  };

  const STORAGE_KEY = "pensionSim_pyramid_v1";

  const AGE_LABELS = [
    "0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49",
    "50-54","55-59","60-64","65-69","70-74","75-79","80-84","85-89","90-94","95-99","100+"
  ];

  const DEFAULTS = {
    popTotalM: 47.0,
    peakIdx: 9,
    sigma: 18,
    densityYoung: 0.75,
    densityOld: 0.75
  };

  const state = { ...DEFAULTS };

  const els = {
    pyrSvg: document.getElementById('pyrSvg'),

    peakShell: document.getElementById('peakShell'),
    peakSlider: document.getElementById('peakSlider'),

    sigmaSlider: document.getElementById('sigmaSlider'),
    sigmaVal: document.getElementById('sigmaVal'),

    densityYoungSlider: document.getElementById('densityYoungSlider'),
    densityYoungVal: document.getElementById('densityYoungVal'),

    densityOldSlider: document.getElementById('densityOldSlider'),
    densityOldVal: document.getElementById('densityOldVal'),

    shareMin: document.getElementById('shareMin'),
    shareWork: document.getElementById('shareWork'),
    shareRet: document.getElementById('shareRet'),

    nextBtn: document.getElementById('nextBtn'),
    oecdBtn: document.getElementById('oecdBtn'),
  };

  const svgEl = (name, attrs={}) => {
    const el = document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, String(v));
    return el;
  };
  const clearSvg = (svg) => { while (svg.firstChild) svg.removeChild(svg.firstChild); };

  function paintRange(input){
    if (!input) return;
    const min = Number(input.min || 0);
    const max = Number(input.max || 100);
    const val = Number(input.value || 0);
    const pct = ((val - min) / Math.max(1e-9, (max - min))) * 100;
    input.style.background = `linear-gradient(to right, ${COLORS.primary} 0%, ${COLORS.primary} ${pct}%, rgba(255,255,255,.12) ${pct}%, rgba(255,255,255,.12) 100%)`;
  }

  function getRenderedSvgHeight(svg){
    const rect = svg.getBoundingClientRect();
    let h = rect.height;
    const w = rect.width || svg.clientWidth || 0;
    const vb = svg.viewBox && svg.viewBox.baseVal;
    if (w > 0 && vb && vb.width > 0 && vb.height > 0){
      const expected = w * (vb.height / vb.width);
      if (!isFinite(h) || h <= 1) h = expected;
    }
    return (isFinite(h) && h > 0) ? h : 0;
  }

  function syncPeakSliderToSvg(){
    const shell = els.peakShell;
    const input = els.peakSlider;
    const svg = els.pyrSvg;
    if (!shell || !input || !svg) return;

    let targetH = getRenderedSvgHeight(svg);
    if (targetH <= 1) return;

    shell.style.height = `${targetH}px`;

    const shellRect = shell.getBoundingClientRect();
    const cs = getComputedStyle(shell);

    const padY = (parseFloat(cs.paddingTop) || 0) + (parseFloat(cs.paddingBottom) || 0);
    const borderY = (parseFloat(cs.borderTopWidth) || 0) + (parseFloat(cs.borderBottomWidth) || 0);

    const usable = Math.max(140, (shellRect.height || targetH) - padY - borderY);
    input.style.width = `${usable}px`;
    input.style.height = `4px`;
    paintRange(input);
  }

  function gaussian(x, mu, sigma){
    const z = (x - mu) / Math.max(1e-6, sigma);
    return Math.exp(-0.5 * z * z);
  }

  function densityPower(d){
    return 0.65 + (d - 0.35) * (2.20 - 0.65) / (1.25 - 0.35);
  }

  function buildSyntheticTotalShares(){
    const n = AGE_LABELS.length;
    const peak = state.peakIdx;
    const sigmaModel = state.sigma / 6.0;

    const pYoung = densityPower(state.densityYoung);
    const pOld   = densityPower(state.densityOld);

    const total = new Array(n).fill(0);

    for (let i=0;i<n;i++){
      let v = gaussian(i, peak, sigmaModel);
      v += 0.22 * gaussian(i, 2.0, sigmaModel * 1.6);

      const tailStart = Math.max(0, peak + 4);
      if (i >= tailStart){
        const t = (i - tailStart);
        v += 0.10 * Math.exp(-t / Math.max(1.5, sigmaModel*1.2));
      }

      const p = (i <= peak) ? pYoung : pOld;
      v = Math.pow(Math.max(0, v), p);

      total[i] = v;
    }

    let s = total.reduce((a,b)=>a+b,0);
    if (s <= 0) s = 1;
    for (let i=0;i<n;i++) total[i] /= s;

    return total;
  }

  function buildSyntheticSharesMF(){
    const total = buildSyntheticTotalShares();
    const n = total.length;

    const m = new Array(n).fill(0);
    const f = new Array(n).fill(0);

    for (let i=0;i<n;i++){
      const ageFactor = i / (n-1);
      const femaleBias = 0.50 + 0.10 * Math.pow(ageFactor, 1.6);
      const fb = Math.min(0.62, Math.max(0.50, femaleBias));
      f[i] = total[i] * fb;
      m[i] = total[i] * (1 - fb);
    }
    return {m,f};
  }

  function sharesFromPyramid(){
    const shares = buildSyntheticTotalShares();

    const minors =
      (shares[0]||0) + (shares[1]||0) + (shares[2]||0) + 0.60*(shares[3]||0);

    let work = 0.40*(shares[3]||0);
    for (let i=4;i<=12;i++) work += (shares[i]||0);

    let retired = 0;
    for (let i=13;i<shares.length;i++) retired += (shares[i]||0);

    let s = minors + work + retired;
    if (s <= 1e-9) s = 1;

    return { sMin: minors/s, sWork: work/s, sRet: retired/s };
  }

  function renderShares(){
    const { sMin, sWork, sRet } = sharesFromPyramid();
    els.shareMin.textContent  = `Menores: ${(sMin*100).toFixed(1)}%`;
    els.shareWork.textContent = `Laboral: ${(sWork*100).toFixed(1)}%`;
    els.shareRet.textContent  = `Mayores: ${(sRet*100).toFixed(1)}%`;
  }

  function labelMidAge(label){
    if (label.includes('+')){
      const start = parseInt(label, 10);
      return isFinite(start) ? start : 100;
    }
    const [a,b] = label.split('-').map(x => parseInt(x, 10));
    const start = isFinite(a) ? a : 0;
    const end = isFinite(b) ? b : start;
    return (start + end) / 2;
  }

  function colorForLabel(label){
    const mid = labelMidAge(label);
    if (mid < 18) return COLORS.primary;
    if (mid < 65) return COLORS.workers;
    return COLORS.retired;
  }

  function renderPyramid(){
    const svg = els.pyrSvg;
    clearSvg(svg);

    const W = 520, H = 650;
    const pad = {l: 90, r: 30, t: 52, b: 26};
    const innerW = W - pad.l - pad.r;
    const innerH = H - pad.t - pad.b;
    const cx = pad.l + innerW/2;

    const {m,f} = buildSyntheticSharesMF();

    const gridLines = 6;
    for (let k=0;k<=gridLines;k++){
      const x = pad.l + (innerW * k/gridLines);
      svg.appendChild(svgEl('line', {
        x1:x, y1:pad.t, x2:x, y2:pad.t+innerH,
        stroke: COLORS.grid, "stroke-width":1, "stroke-opacity":"0.30"
      }));
    }

    svg.appendChild(svgEl('line',{
      x1: cx, y1: pad.t, x2: cx, y2: pad.t+innerH,
      stroke: COLORS.text, "stroke-width":1.2, "stroke-opacity":"0.65"
    }));

    svg.appendChild(svgEl('text',{
      x: cx - 10, y: 50,
      fill: COLORS.workers,
      "font-size": "13",
      "font-family":"Arial, sans-serif",
      "text-anchor":"end",
      "opacity":"0.92"
    })).textContent = "Hombre";

    svg.appendChild(svgEl('text',{
      x: cx + 10, y: 50,
      fill: COLORS.retired,
      "font-size": "13",
      "font-family":"Arial, sans-serif",
      "text-anchor":"start",
      "opacity":"0.92"
    })).textContent = "Mujer";

    let maxBin = 0;
    for (let i=0;i<m.length;i++) maxBin = Math.max(maxBin, m[i], f[i]);
    if (maxBin <= 0) maxBin = 1;

    const maxPx = (innerW/2) * 0.92;

    const n = AGE_LABELS.length;
    const barH = innerH / n;

    for (let i=0;i<n;i++){
      const y = pad.t + (n - 1 - i) * barH + 1;
      const h = Math.max(1, barH - 2);

      const wL = (m[i] / maxBin) * maxPx;
      const wR = (f[i] / maxBin) * maxPx;

      svg.appendChild(svgEl('rect',{
        x: cx - wL, y, width: wL, height: h,
        fill: COLORS.workers, "fill-opacity":"0.80"
      }));
      svg.appendChild(svgEl('rect',{
        x: cx, y, width: wR, height: h,
        fill: COLORS.retired, "fill-opacity":"0.80"
      }));

      const t = svgEl('text',{
        x: 12, y: y + h*0.72,
        fill: colorForLabel(AGE_LABELS[i]),
        "font-size": "12",
        "font-family":"Arial, sans-serif",
        "opacity":"0.95"
      });
      t.textContent = AGE_LABELS[i];
      svg.appendChild(t);
    }

    renderShares();
    requestAnimationFrame(syncPeakSliderToSvg);
  }

  function saveState(){
    const payload = {
      popTotalM: state.popTotalM,
      peakIdx: state.peakIdx,
      sigma: state.sigma,
      densityYoung: state.densityYoung,
      densityOld: state.densityOld
    };
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;

      for (const k of Object.keys(DEFAULTS)){
        if (obj[k] !== undefined && obj[k] !== null && isFinite(Number(obj[k]))){
          state[k] = Number(obj[k]);
        }
      }
    }catch(e){}
  }

  function syncUI(){
    els.peakSlider.value = state.peakIdx;

    els.sigmaSlider.value = state.sigma;
    els.sigmaVal.textContent = String(state.sigma);

    els.densityYoungSlider.value = state.densityYoung;
    els.densityYoungVal.textContent = state.densityYoung.toFixed(2);

    els.densityOldSlider.value = state.densityOld;
    els.densityOldVal.textContent = state.densityOld.toFixed(2);

    [els.peakSlider, els.sigmaSlider, els.densityYoungSlider, els.densityOldSlider].forEach(paintRange);
  }

  // Helpers: detección móvil/escritorio
  function isMobileView(){
    // coherente con tu criterio anterior: <= 900px -> móvil
    return window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
  }

  function goToSimulator(){
    const target = isMobileView() ? "movil_simulador.html" : "simulador.html";
    window.location.href = target;
  }

  // Eventos
  els.peakSlider.addEventListener('input', (e) => {
    state.peakIdx = Number(e.target.value);
    paintRange(els.peakSlider);
    saveState();
    renderPyramid();
  });

  els.sigmaSlider.addEventListener('input', (e) => {
    state.sigma = Number(e.target.value);
    els.sigmaVal.textContent = String(state.sigma);
    paintRange(els.sigmaSlider);
    saveState();
    renderPyramid();
  });

  els.densityYoungSlider.addEventListener('input', (e) => {
    state.densityYoung = Number(e.target.value);
    els.densityYoungVal.textContent = state.densityYoung.toFixed(2);
    paintRange(els.densityYoungSlider);
    saveState();
    renderPyramid();
  });

  els.densityOldSlider.addEventListener('input', (e) => {
    state.densityOld = Number(e.target.value);
    els.densityOldVal.textContent = state.densityOld.toFixed(2);
    paintRange(els.densityOldSlider);
    saveState();
    renderPyramid();
  });

  // Aceptar -> tu flujo actual
  els.nextBtn.addEventListener('click', () => {
    saveState();
    window.location.href = "parametrosTiempo.html";
  });

  // Cargar países OCDE -> simulador según dispositivo
  els.oecdBtn.addEventListener('click', () => {
    saveState();
    goToSimulator();
  });

  window.addEventListener('resize', () => {
    requestAnimationFrame(syncPeakSliderToSvg);
  });

  // Init
  loadState();
  syncUI();
  renderPyramid();

  window.addEventListener('load', () => {
    requestAnimationFrame(syncPeakSliderToSvg);
  });
})();
</script>

</body>
</html>
