<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pensiones — Evolución en el tiempo (Parámetros)</title>

  <style>
    :root{
      --bg:#252525;
      --primary:#FEF702;
      --text:#B0B0B0;
      --grid:#4A4A4A;

      --workers:#36C3FF;
      --retired:#FF6A00;
      --minors:#7f7f7f;
      --noncot:#1f6d86;

      --stroke:#3a3a3a;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:16px;

      --fontTitle: "Futura","Trebuchet MS",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --fontText:  Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;

      /* Escalas del SVG */
      --fontScale: 1.35;
      --chartTextBoost: 1.0;

      /* Gaps (controlan padding real) */
      --timeXAxisLabelGap: 86px;
      --timeYAxisLabelGap: 70px;
      --timeLegendToChartGap: 130px;

      --timeLegendFontScale: 1.35;
      --timeLegendItemGap: 72px;

      --timeChartWidth: 100%;

      --axisLabelGap: 60px;
      --axisLabelFontScale: 1.4;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--fontText); }

    header{
      padding:16px 18px 10px 18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .h-title h1{
      margin:0;
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 26px;
      letter-spacing:.3px;
      line-height:1.05;
    }
    .h-title p{
      margin:6px 0 0 0;
      opacity:.9;
      font-size:13px;
      max-width:96ch;
      line-height:1.35;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:12px;
      opacity:.9;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--primary);
      box-shadow:0 0 0 3px rgba(254,247,2,.15);
    }
    a.back{
      color:var(--text);
      text-decoration:none;
      border-bottom:1px solid rgba(255,255,255,.18);
      padding-bottom:1px;
    }
    a.back:hover{ border-bottom-color: rgba(254,247,2,.35); color:#fff; }

    main{ padding:10px 18px 22px 18px; }

    .panel{
      max-width: 1180px;
      margin: 0 auto;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .ph{
      padding:14px 16px 12px 16px;
      border-bottom:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .ttl{
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 13px;
      letter-spacing:.35px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .sub{
      font-size: 12px;
      opacity:.85;
      line-height:1.35;
      flex:1 1 auto;
      min-width:280px;
    }
    .mono{ font-variant-numeric: tabular-nums; }

    .content{
      padding:14px 16px 16px 16px;
      display:grid;
      grid-template-columns: 1.25fr 0.95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .content{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      background:rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card .ch{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .cttl{
      font-family:var(--fontTitle);
      color:var(--primary);
      font-size: 12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .card .csub{
      font-size:12px;
      opacity:.85;
      font-variant-numeric: tabular-nums;
      width:100%;
      line-height:1.2;
    }
    .card .cb{ padding:12px; display:grid; gap:12px; }

    .bigsvg{
      width:100%;
      height:auto;
      aspect-ratio: 1000 / 700;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.05);
      background:rgba(0,0,0,.08);
      display:block;
    }
    #timeSvg{ width: var(--timeChartWidth); margin: 0 auto; }

    .ctl{ display:grid; gap:6px; }
    .ctl label{
      font-size:13px;
      opacity:.92;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .val{ font-variant-numeric: tabular-nums; opacity:.95; }

    /* ====== SLIDERS: misma modificación que el código de referencia (thumb centrado) ====== */
    input[type="range"]{
      width:100%;
      display:block;
      margin:0;
      accent-color: var(--primary);
      background: rgba(255,255,255,.12);
      border-radius:999px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 4px;
      background: transparent;
      border-radius:999px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      border: 1px solid rgba(0,0,0,.35);
      margin-top: -5px;
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    input[type="range"]::-moz-range-track{
      height:4px;
      background: transparent;
      border-radius:999px;
    }
    input[type="range"]::-moz-range-thumb{
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      border: 1px solid rgba(0,0,0,.35);
      box-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      align-items:baseline;
      padding:12px;
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      background:rgba(0,0,0,.08);
      font-size:12px;
    }
    .kv .k{ opacity:.85; }
    .kv .v{ color:#fff; font-variant-numeric: tabular-nums; }

    .result-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
      opacity:.95;
    }
    .result-dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--primary);
      box-shadow:0 0 0 3px rgba(254,247,2,.12);
      flex:0 0 auto;
    }
    .result-dot.ok{ background: var(--workers); box-shadow:0 0 0 3px rgba(54,195,255,.12); }
    .result-dot.bad{ background: var(--retired); box-shadow:0 0 0 3px rgba(255,106,0,.12); }

    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; width:100%; } /* <-- MOD: asegura que el contenedor pueda ocupar todo el ancho */
    .btn{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      min-width:170px;
      text-align:center;
      font-size:13px;
    }
    .btn:hover{
      border-color: rgba(254,247,2,.35);
      color:#fff;
      background: rgba(254,247,2,.06);
    }
    .btn.primary{
      border-color: rgba(254,247,2,.35);
      color:#111;
      background: rgba(254,247,2,.90);
      width:100%;               /* <-- MOD: el botón Aceptar ocupa todo el ancho */
      min-width:0;              /* <-- MOD: evita que el min-width impida el 100% en layouts estrechos */
      display:block;            /* <-- MOD: asegura comportamiento de bloque */
    }
    .btn.primary:hover{ background: rgba(254,247,2,1); }

    .note{
      font-size:12px;
      opacity:.78;
      line-height:1.35;
      border-top:1px solid rgba(255,255,255,.06);
      padding-top:8px;
    }
  </style>
</head>

<body>
<header>
  <div class="h-title">
    <h1>Evolución en el tiempo</h1>
    <p>
      ajusta el crecimiento de la población y sus diferentes cohortes demográficas
    </p>
  </div>
  <div class="pill">
    <span class="dot"></span>
    <span><a class="back" href="piramidePoblacional.html">Volver a pirámide</a></span>
  </div>
</header>

<main>
  <section class="panel" aria-label="Configuración evolución en el tiempo (con gráfica)">
    <div class="ph">
      <div class="ttl">Paso 2 — Tiempo</div>
      <div class="sub"></div>
    </div>

    <div class="content">
      <!-- Gráfica -->
      <div class="card" aria-label="Gráfica evolución en el tiempo">
        <div class="ch">
          <div class="cttl">Gráfica</div>
        </div>
        <div class="cb">
          <svg id="timeSvg" class="bigsvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet" aria-label="Evolución en el tiempo"></svg>
        </div>
      </div>

      <!-- Controles -->
      <div class="card" aria-label="Parámetros">
        <div class="ch">
          <div class="cttl">Parámetros</div>
          <div class="csub mono" id="kLine">k = τ/ρ: —</div>
        </div>

        <div class="cb">
          <div class="ctl">
            <label>
              <span>Paro (u): % de 18–64 que NO cotiza</span>
              <span class="val mono" id="uVal">10%</span>
            </label>
            <input id="uSlider" type="range" min="0" max="35" step="1" value="10" />
          </div>

          <div class="ctl">
            <label>
              <span>Crec. población anual</span>
              <span class="val mono" id="popGrowthVal">0.30%</span>
            </label>
            <input id="popGrowthSlider" type="range" min="-1.50" max="2.50" step="0.05" value="0.30" />
          </div>

          <div class="ctl">
            <label>
              <span>Envejecimiento anual (Δ share 65+)</span>
              <span class="val mono" id="agingVal">+0.20</span>
            </label>
            <input id="agingSlider" type="range" min="-0.50" max="0.80" step="0.01" value="0.20" />
          </div>

          <div class="ctl">
            <label>
              <span>Años a simular</span>
              <span class="val mono" id="yearsVal">80</span>
            </label>
            <input id="yearsSlider" type="range" min="20" max="140" step="5" value="80" />
          </div>

          <div class="kv" aria-label="Resumen guardado">
            <div class="k">k = τ/ρ</div><div class="v mono" id="kVal">—</div>
            <div class="k">u (fracción)</div><div class="v mono" id="uFrac">—</div>
            <div class="k">popGrowth</div><div class="v mono" id="popGrowthFrac">—</div>
            <div class="k">agingPP</div><div class="v mono" id="agingFrac">—</div>
            <div class="k">years</div><div class="v mono" id="yearsOut">—</div>
          </div>

          <div class="btn-row">
            <div class="btns"></div>
            <div class="btns">
              <button id="nextBtn" class="btn primary" type="button">Aceptar</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </section>
</main>

<script>
(() => {
  const CSS = (v) => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

  const COLORS = {
    primary: CSS('--primary'),
    text: CSS('--text'),
    grid: CSS('--grid'),
    workers: CSS('--workers'),
    retired: CSS('--retired'),
    minors: CSS('--minors'),
    noncot: CSS('--noncot'),
  };

  const PYR_KEY  = "pensionSim_pyramid_v1";
  const TIME_KEY = "pensionSim_time_v1";

  const DEFAULT_PYR = {
    popTotalM: 47.0,
    peakIdx: 9,
    sigma: 18,
    densityYoung: 0.75,
    densityOld: 0.75
  };

  const DEFAULT_TIME = {
    rho: 0.80,
    tau: 0.29,
    u: 0.10,            // fracción
    popGrowth: 0.003,   // fracción
    agingPP: 0.002,     // fracción (0.20 pp)
    years: 80
  };

  const state = {
    pyr: { ...DEFAULT_PYR },
    time: { ...DEFAULT_TIME },
    t: 0,
    timeLayout: null,
    draggingTime: false
  };

  const els = {
    timeSvg: document.getElementById("timeSvg"),

    uSlider: document.getElementById("uSlider"),
    popGrowthSlider: document.getElementById("popGrowthSlider"),
    agingSlider: document.getElementById("agingSlider"),
    yearsSlider: document.getElementById("yearsSlider"),

    uVal: document.getElementById("uVal"),
    popGrowthVal: document.getElementById("popGrowthVal"),
    agingVal: document.getElementById("agingVal"),
    yearsVal: document.getElementById("yearsVal"),

    kLine: document.getElementById("kLine"),
    kVal: document.getElementById("kVal"),
    uFrac: document.getElementById("uFrac"),
    popGrowthFrac: document.getElementById("popGrowthFrac"),
    agingFrac: document.getElementById("agingFrac"),
    yearsOut: document.getElementById("yearsOut"),

    nextBtn: document.getElementById("nextBtn"),
  };

  const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
  const toM = (x) => x / 1_000_000;

  const getFontScale = () => parseFloat(CSS('--fontScale')) || 1;

  const getAxisLabelGap = () => {
    const v = parseFloat(CSS('--axisLabelGap'));
    return isFinite(v) ? v : 60;
  };

  const getAxisLabelFontScale = () => {
    const v = parseFloat(CSS('--axisLabelFontScale'));
    return isFinite(v) ? v : 1;
  };

  const fs = (px) => (px * getFontScale()).toFixed(2);
  const fsTick = (px) => (px * getFontScale()).toFixed(2);
  const fsAxisLabel = (px) => (px * getFontScale() * getAxisLabelFontScale()).toFixed(2);

  const svgEl = (name, attrs={}) => {
    const el = document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, String(v));
    return el;
  };
  const clearSvg = (svg) => { while (svg.firstChild) svg.removeChild(svg.firstChild); };

  function paintRange(input){
    if (!input) return;
    const min = Number(input.min || 0);
    const max = Number(input.max || 100);
    const val = Number(input.value || 0);
    const pct = ((val - min) / Math.max(1e-9, (max - min))) * 100;
    input.style.background =
      `linear-gradient(to right, ${COLORS.primary} 0%, ${COLORS.primary} ${pct}%, rgba(255,255,255,.12) ${pct}%, rgba(255,255,255,.12) 100%)`;
  }

  function kEquilibrium(){
    return state.time.tau / Math.max(1e-9, state.time.rho);
  }

  function gaussian(x, mu, sigma){
    const z = (x - mu) / Math.max(1e-6, sigma);
    return Math.exp(-0.5 * z * z);
  }

  function densityPower(d){
    return 0.65 + (d - 0.35) * (2.20 - 0.65) / (1.25 - 0.35);
  }

  function buildSyntheticTotalShares(){
    const n = 21;
    const peak = state.pyr.peakIdx;
    const sigmaModel = state.pyr.sigma / 6.0;

    const pYoung = densityPower(state.pyr.densityYoung);
    const pOld   = densityPower(state.pyr.densityOld);

    const total = new Array(n).fill(0);

    for (let i=0;i<n;i++){
      let v = gaussian(i, peak, sigmaModel);
      v += 0.22 * gaussian(i, 2.0, sigmaModel * 1.6);

      const tailStart = Math.max(0, peak + 4);
      if (i >= tailStart){
        const t = (i - tailStart);
        v += 0.10 * Math.exp(-t / Math.max(1.5, sigmaModel*1.2));
      }

      const p = (i <= peak) ? pYoung : pOld;
      v = Math.pow(Math.max(0, v), p);

      total[i] = v;
    }

    let s = total.reduce((a,b)=>a+b,0);
    if (s <= 0) s = 1;
    for (let i=0;i<n;i++) total[i] /= s;

    return total;
  }

  function sharesFromPyramid(){
    const shares = buildSyntheticTotalShares();

    const minors =
      (shares[0]||0) + (shares[1]||0) + (shares[2]||0) + 0.60*(shares[3]||0);

    let work = 0.40*(shares[3]||0);
    for (let i=4;i<=12;i++) work += (shares[i]||0);

    let retired = 0;
    for (let i=13;i<shares.length;i++) retired += (shares[i]||0);

    let s = minors + work + retired;
    if (s <= 1e-9) s = 1;
    return { sMin: minors/s, sWork: work/s, sRet: retired/s };
  }

  function buildSeries(){
    const T = state.time.years;
    const series = [];

    let total = state.pyr.popTotalM * 1_000_000;

    const base = sharesFromPyramid();
    let sMin = clamp(base.sMin, 0.02, 0.70);
    let sWork = clamp(base.sWork, 0.10, 0.80);
    let sRet = clamp(base.sRet, 0.02, 0.60);

    let n0 = sMin + sWork + sRet;
    sMin /= n0; sWork /= n0; sRet /= n0;

    const participation = 1.00;

    for (let t=0; t<=T; t++){
      const minors = total * sMin;
      const workingAge = total * sWork;
      const retired = total * sRet;

      const labour = workingAge * clamp(participation,0,1);
      const unemployed = labour * clamp(state.time.u,0,1);
      const cotEff = labour - unemployed;
      const inactive = Math.max(0, workingAge - labour);

      series.push({
        t, total,
        minors,
        cot: cotEff,
        inactive,
        noncot: unemployed,
        retired,
        sMin, sWork, sRet
      });

      total = total * (1 + state.time.popGrowth);

      const dR = state.time.agingPP;
      let takeFromWork = Math.min(sWork, dR);
      sWork -= takeFromWork;
      let rem = dR - takeFromWork;
      if (rem > 0){
        let takeFromMin = Math.min(sMin, rem);
        sMin -= takeFromMin;
        rem -= takeFromMin;
      }
      sRet = clamp(sRet + dR, 0.02, 0.85);

      const n = sMin + sWork + sRet;
      if (n > 1e-9){
        sMin /= n; sWork /= n; sRet /= n;
      }
    }
    return series;
  }

  function renderTimeLegendHorizontal(svg, y){
    const items = [
      { label: "Menores (<18)", fill: COLORS.minors, op: "0.35" },
      { label: "Cotizantes efectivos", fill: COLORS.workers, op: "0.50" },
      { label: "Desempleados", fill: COLORS.noncot, op: "0.55" },
      { label: "Jubilados (65+)", fill: COLORS.retired, op: "0.50" }
    ];

    const g = svgEl('g', { "opacity":"0.95" });

    const box = 14;
    const gap = 10;
    const after = 105;

    let x = 0;

    items.forEach((it) => {
      g.appendChild(svgEl('rect', {
        x: x, y: y - (box - 2),
        width: box, height: box,
        fill: it.fill,
        "fill-opacity": it.op,
        stroke: COLORS.text,
        "stroke-width":"1",
        "stroke-opacity":"0.20",
        rx:"3", ry:"3"
      }));

      const t = svgEl('text', {
        x: x + box + gap,
        y: y + 2,
        fill: COLORS.text,
        "font-size": fsTick(18),
        "font-family":"Arial, sans-serif",
        "text-anchor":"start",
        "opacity":"0.92"
      });
      t.textContent = it.label;
      g.appendChild(t);

      x = x + box + gap + (it.label.length * 7.2) + after;
    });

    svg.appendChild(g);

    try{
      const bb = g.getBBox();
      const tx = (1000 - bb.width) / 2 - bb.x;
      g.setAttribute("transform", `translate(${tx.toFixed(2)} 0)`);
    } catch(e){}
  }

  function renderTimeChart(){
    const svg = els.timeSvg;
    clearSvg(svg);

    const W = 1000, H = 700;
    const pad = {l: 90, r: 30, t: 24, b: 140};
    const innerW = W - pad.l - pad.r;
    const innerH = H - pad.t - pad.b;

    const data = buildSeries();
    const T = state.time.years;

    state.timeLayout = { W, H, pad, innerW, innerH, T };

    const yMax = Math.max(...data.map(d => d.total)) / 1_000_000;
    const yNice = Math.ceil(yMax/5)*5 || 5;

    const xToPx = (x) => pad.l + (x / T) * innerW;
    const yToPx = (yM) => pad.t + innerH - (yM / yNice) * innerH;

    const yTicks = 6;
    for (let i=0;i<=yTicks;i++){
      const yv = (yNice * i / yTicks);
      svg.appendChild(svgEl('line',{
        x1: pad.l, y1: yToPx(yv), x2: pad.l+innerW, y2: yToPx(yv),
        stroke: COLORS.grid, "stroke-width":"1", "stroke-opacity":"0.45",
        "stroke-dasharray":"6 6"
      }));
      const t = svgEl('text',{
        x: pad.l - 10, y: yToPx(yv) + 4,
        fill: COLORS.text, "font-size": fsTick(12), "font-family":"Arial, sans-serif",
        "text-anchor":"end", "opacity":"0.90"
      });
      t.textContent = String(Math.round(yv));
      svg.appendChild(t);
    }

    const xTicks = 5;
    for (let i=0;i<=xTicks;i++){
      const xv = Math.round(T * i / xTicks);
      svg.appendChild(svgEl('line',{
        x1: xToPx(xv), y1: pad.t, x2: xToPx(xv), y2: pad.t+innerH,
        stroke: COLORS.grid, "stroke-width":"1", "stroke-opacity":"0.30"
      }));
      const t = svgEl('text',{
        x: xToPx(xv), y: pad.t + innerH + 26,
        fill: COLORS.text, "font-size": fsTick(12), "font-family":"Arial, sans-serif",
        "text-anchor":"middle", "opacity":"0.90"
      });
      t.textContent = String(xv);
      svg.appendChild(t);
    }

    svg.appendChild(svgEl('line',{
      x1: pad.l, y1: pad.t+innerH, x2: pad.l+innerW, y2: pad.t+innerH,
      stroke: COLORS.text, "stroke-width":"1.2", "stroke-opacity":"0.9"
    }));
    svg.appendChild(svgEl('line',{
      x1: pad.l, y1: pad.t, x2: pad.l, y2: pad.t+innerH,
      stroke: COLORS.text, "stroke-width":"1.2", "stroke-opacity":"0.9"
    }));

    const xAxisLabelY = Math.min(H - 44, pad.t + innerH + getAxisLabelGap());
    svg.appendChild(svgEl('text',{
      x: pad.l + innerW/2, y: xAxisLabelY,
      fill: COLORS.text, "font-size": fsAxisLabel(14), "font-family":"Arial, sans-serif",
      "text-anchor":"middle", "opacity":"0.95"
    })).textContent = "Años / turnos";

    const legendY = Math.min(H - 16, xAxisLabelY + 30);
    renderTimeLegendHorizontal(svg, legendY);

    const yLabelX = Math.max(10, pad.l - getAxisLabelGap());
    svg.appendChild(svgEl('text',{
      x: yLabelX, y: pad.t + innerH/2,
      fill: COLORS.text, "font-size": fsAxisLabel(14), "font-family":"Arial, sans-serif",
      "text-anchor":"middle", "opacity":"0.95",
      transform: `rotate(-90 ${yLabelX} ${pad.t + innerH/2})`
    })).textContent = "Personas (millones)";

    const minorsTop = [];
    const cotTop = [];
    const noncotTop = [];
    const totalTop = [];
    const basePts = [];

    data.forEach(d => {
      const x = xToPx(d.t);
      const mM = toM(d.minors);
      const cM = toM(d.cot + (d.inactive || 0));
      const nM = toM(d.noncot);
      const rM = toM(d.retired);

      minorsTop.push([x, yToPx(mM)]);
      cotTop.push([x, yToPx(mM + cM)]);
      noncotTop.push([x, yToPx(mM + cM + nM)]);
      totalTop.push([x, yToPx(mM + cM + nM + rM)]);
      basePts.push([x, yToPx(0)]);
    });

    function polyPath(topPts, bottomPts){
      const pts = topPts.concat(bottomPts.slice().reverse());
      return "M " + pts.map(p => `${p[0].toFixed(2)} ${p[1].toFixed(2)}`).join(" L ") + " Z";
    }

    svg.appendChild(svgEl('path', { d: polyPath(minorsTop, basePts), fill: COLORS.minors, "fill-opacity":"0.35", stroke:"none" }));
    svg.appendChild(svgEl('path', { d: polyPath(cotTop, minorsTop),   fill: COLORS.workers,"fill-opacity":"0.50", stroke:"none" }));

    if (state.time.u > 1e-9){
      svg.appendChild(svgEl('path', { d: polyPath(noncotTop, cotTop), fill: COLORS.noncot, "fill-opacity":"0.55", stroke:"none" }));
    }

    svg.appendChild(svgEl('path', { d: polyPath(totalTop, noncotTop), fill: COLORS.retired,"fill-opacity":"0.50", stroke:"none" }));

    svg.appendChild(svgEl('path', {
      d: "M " + totalTop.map(p => `${p[0].toFixed(2)} ${p[1].toFixed(2)}`).join(" L "),
      fill: "none",
      stroke: "#FFFFFF",
      "stroke-width":"3",
      "stroke-opacity":"0.95"
    }));

    const tNow = clamp(Math.round(state.t), 0, state.time.years);
    const cur = data[Math.min(data.length-1, tNow)];
    const xNow = xToPx(cur.t);

    svg.appendChild(svgEl('line', {
      x1: xNow, y1: pad.t, x2: xNow, y2: pad.t+innerH,
      stroke: COLORS.primary,
      "stroke-width":"2",
      "stroke-opacity":"0.65",
      "stroke-dasharray":"8 6"
    }));

    svg.appendChild(svgEl('circle', {
      cx: xNow, cy: yToPx(toM(cur.total)), r: "5.5",
      fill: COLORS.primary, "fill-opacity":"0.95"
    }));
  }

  function viewXFromClientX(svg, clientX){
    const rect = svg.getBoundingClientRect();
    if (!rect || rect.width <= 0) return 0;
    return ((clientX - rect.left) / rect.width) * 1000;
  }

  function setTimeFromClientX(clientX){
    const L = state.timeLayout;
    if (!L) return;

    const x = viewXFromClientX(els.timeSvg, clientX);
    const t = ((x - L.pad.l) / L.innerW) * L.T;
    state.t = clamp(Math.round(t), 0, state.time.years);

    renderTimeChart();
    syncDerivedUI();
  }

  function setupTimeScrub(){
    els.timeSvg.style.cursor = "ew-resize";
    els.timeSvg.style.touchAction = "none";

    els.timeSvg.addEventListener("pointerdown", (e) => {
      state.draggingTime = true;
      try{ els.timeSvg.setPointerCapture(e.pointerId); }catch(err){}
      setTimeFromClientX(e.clientX);
    });

    els.timeSvg.addEventListener("pointermove", (e) => {
      if (!state.draggingTime) return;
      setTimeFromClientX(e.clientX);
    });

    const end = () => { state.draggingTime = false; };

    els.timeSvg.addEventListener("pointerup", end);
    els.timeSvg.addEventListener("pointercancel", end);
    els.timeSvg.addEventListener("pointerleave", end);
  }

  function loadPyramid(){
    try{
      const raw = localStorage.getItem(PYR_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;

      if (isFinite(Number(obj.popTotalM))) state.pyr.popTotalM = Number(obj.popTotalM);
      if (isFinite(Number(obj.peakIdx))) state.pyr.peakIdx = Number(obj.peakIdx);
      if (isFinite(Number(obj.sigma))) state.pyr.sigma = Number(obj.sigma);
      if (isFinite(Number(obj.densityYoung))) state.pyr.densityYoung = Number(obj.densityYoung);
      if (isFinite(Number(obj.densityOld))) state.pyr.densityOld = Number(obj.densityOld);
    }catch(e){}
  }

  function loadTime(){
    try{
      const raw = localStorage.getItem(TIME_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;

      if (isFinite(Number(obj.rho))) state.time.rho = Number(obj.rho);
      if (isFinite(Number(obj.tau))) state.time.tau = Number(obj.tau);
      if (isFinite(Number(obj.u))) state.time.u = clamp(Number(obj.u), 0, 1);
      if (isFinite(Number(obj.popGrowth))) state.time.popGrowth = Number(obj.popGrowth);
      if (isFinite(Number(obj.agingPP))) state.time.agingPP = Number(obj.agingPP);
      if (isFinite(Number(obj.years))) state.time.years = clamp(Number(obj.years), 20, 140);
    }catch(e){}
  }

  function saveTime(){
    const payload = {
      rho: state.time.rho,
      tau: state.time.tau,
      u: state.time.u,
      popGrowth: state.time.popGrowth,
      agingPP: state.time.agingPP,
      years: state.time.years
    };
    try{ localStorage.setItem(TIME_KEY, JSON.stringify(payload)); }catch(e){}
  }

  function syncUI(){
    const t = state.time;

    els.uSlider.value = Math.round(t.u * 100);
    els.popGrowthSlider.value = (t.popGrowth * 100).toFixed(2);
    els.agingSlider.value = (t.agingPP * 100).toFixed(2);
    els.yearsSlider.value = t.years;

    els.uVal.textContent = `${Math.round(t.u*100)}%`;
    els.popGrowthVal.textContent = `${(t.popGrowth*100).toFixed(2)}%`;
    els.agingVal.textContent = `+${(t.agingPP*100).toFixed(2)} pp`;
    els.yearsVal.textContent = String(t.years);

    [els.uSlider, els.popGrowthSlider, els.agingSlider, els.yearsSlider].forEach(paintRange);

    syncDerivedUI();
  }

  function syncDerivedUI(){
    const t = state.time;
    const k = kEquilibrium();

    els.kLine.textContent = `k = τ/ρ: ${k.toFixed(2)}`;
    els.kVal.textContent = k.toFixed(3);
    els.uFrac.textContent = t.u.toFixed(3);
    els.popGrowthFrac.textContent = t.popGrowth.toFixed(4);
    els.agingFrac.textContent = t.agingPP.toFixed(4);
    els.yearsOut.textContent = String(t.years);
  }

  function rerender(){
    state.t = clamp(state.t, 0, state.time.years);
    renderTimeChart();
  }

  // Events
  els.uSlider.addEventListener("input", (e) => {
    state.time.u = clamp(Number(e.target.value)/100, 0, 1);
    saveTime(); syncUI(); rerender();
  });

  els.popGrowthSlider.addEventListener("input", (e) => {
    state.time.popGrowth = Number(e.target.value)/100;
    saveTime(); syncUI(); rerender();
  });

  els.agingSlider.addEventListener("input", (e) => {
    state.time.agingPP = Number(e.target.value)/100;
    saveTime(); syncUI(); rerender();
  });

  els.yearsSlider.addEventListener("input", (e) => {
    state.time.years = clamp(Number(e.target.value), 20, 140);
    state.t = clamp(state.t, 0, state.time.years);
    saveTime(); syncUI(); rerender();
  });

  els.nextBtn.addEventListener("click", () => {
    saveTime();
    window.location.href = "simulador.html";
  });

  window.addEventListener("resize", () => {
    rerender();
  });

  // Init
  loadPyramid();
  loadTime();
  state.t = state.time.years;  // por defecto: marcar el final
  saveTime();
  syncUI();
  rerender();
  setupTimeScrub();
})();
</script>

</body>
</html>
